<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLoRA - FORRT Library of Replication Attempts</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">

    <style>
        :root {
            --flora-primary: #2c5282;
            --flora-secondary: #4299e1;
            --flora-success: #38a169;
            --flora-danger: #e53e3e;
            --flora-warning: #d69e2e;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--flora-primary) 0%, var(--flora-secondary) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            margin-bottom: 0;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            background: white;
            border-bottom: 2px solid var(--flora-secondary);
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
            color: var(--flora-primary);
        }

        .table thead th {
            background-color: var(--flora-primary);
            color: white;
            border: none;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-successful {
            background-color: var(--flora-success);
            color: white;
        }

        .badge-failed {
            background-color: var(--flora-danger);
            color: white;
        }

        .badge-mixed {
            background-color: var(--flora-warning);
            color: white;
        }

        .badge-inconclusive, .badge-unknown {
            background-color: #718096;
            color: white;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--flora-secondary);
        }

        .stats-card {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: white;
            margin-bottom: 1rem;
        }

        .stats-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--flora-primary);
        }

        .stats-card .label {
            color: #666;
            font-size: 0.875rem;
        }

        .doi-link {
            color: var(--flora-secondary);
            text-decoration: none;
        }

        .doi-link:hover {
            text-decoration: underline;
        }

        .dataTables_filter input {
            border-radius: 20px;
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
        }

        .dataTables_filter input:focus {
            border-color: var(--flora-secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .footer {
            text-align: center;
            padding: 1rem;
            color: #666;
            font-size: 0.875rem;
        }

        .footer a {
            color: var(--flora-secondary);
        }

        /* Responsive table text */
        @media (max-width: 768px) {
            .table td, .table th {
                font-size: 0.85rem;
            }
        }

        /* Row expansion styles */
        td.details-control {
            cursor: pointer;
            text-align: center;
            color: var(--flora-secondary);
            font-size: 0.9rem;
        }

        td.details-control:hover {
            color: var(--flora-primary);
        }

        td.details-control::before {
            content: "â–¶";
            display: inline-block;
            transition: transform 0.2s ease;
        }

        tr.shown td.details-control::before {
            transform: rotate(90deg);
        }

        .detail-row {
            background-color: #f8fafc;
            padding: 1rem;
        }

        .detail-row h6 {
            color: var(--flora-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.25rem;
        }

        .detail-section {
            margin-bottom: 1rem;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
            display: inline-block;
            min-width: 120px;
        }

        .detail-value {
            color: #2d3748;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .detail-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Hidden searchable content */
        .searchable-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>FLoRA</h1>
            <p>FORRT Library of Replication Attempts - Explore replication studies in psychology and beyond</p>
        </div>
    </div>

    <div class="container">
        <!-- Stats Row -->
        <div class="row mb-4" id="stats-row" style="display: none;">
            <div class="col-6 col-md-3">
                <div class="stats-card">
                    <div class="number" id="total-count">-</div>
                    <div class="label">Total Studies</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stats-card">
                    <div class="number" id="successful-count" style="color: var(--flora-success);">-</div>
                    <div class="label">Successful</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stats-card">
                    <div class="number" id="failed-count" style="color: var(--flora-danger);">-</div>
                    <div class="label">Failed</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stats-card">
                    <div class="number" id="mixed-count" style="color: var(--flora-warning);">-</div>
                    <div class="label">Mixed</div>
                </div>
            </div>
        </div>

        <!-- Main Table Card -->
        <div class="card">
            <div class="card-header">
                Replication Studies Database
            </div>
            <div class="card-body">
                <div id="loading" class="loading-spinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-3">Loading FLoRA data...</span>
                </div>
                <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                <table id="flora-table" class="table table-striped table-hover" style="width:100%; display: none;">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Original Study</th>
                            <th>Year</th>
                            <th>Replication Study</th>
                            <th>Year</th>
                            <th>Outcome</th>
                            <th>Type</th>
                            <th>Original DOI</th>
                            <th>Replication Report</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            Data source: <a href="https://github.com/forrtproject/FReD-data" target="_blank">FORRT FReD Project</a> |
            <a href="https://forrt.org/" target="_blank">FORRT - Framework for Open and Reproducible Research Training</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        const CSV_URL = 'https://raw.githubusercontent.com/forrtproject/FReD-data/refs/heads/main/output/flora.csv';

        // Store full row data for detail display
        let fullRowData = [];

        function getOutcomeBadge(outcome) {
            if (!outcome) return '<span class="badge badge-unknown">Unknown</span>';

            const outcomeLower = outcome.toLowerCase().trim();

            if (outcomeLower.includes('success') || outcomeLower === 'replicated') {
                return `<span class="badge badge-successful">${outcome}</span>`;
            } else if (outcomeLower.includes('fail') || outcomeLower === 'not replicated') {
                return `<span class="badge badge-failed">${outcome}</span>`;
            } else if (outcomeLower.includes('mixed') || outcomeLower.includes('partial')) {
                return `<span class="badge badge-mixed">${outcome}</span>`;
            } else if (outcomeLower.includes('inconclusive')) {
                return `<span class="badge badge-inconclusive">${outcome}</span>`;
            }

            return `<span class="badge badge-unknown">${outcome}</span>`;
        }

        function formatDOI(doi, full = false) {
            if (!doi) return '-';
            const doiUrl = doi.startsWith('http') ? doi : `https://doi.org/${doi}`;
            const shortDoi = doi.replace('https://doi.org/', '').replace('http://doi.org/', '');
            if (full) {
                return `<a href="${doiUrl}" target="_blank" class="doi-link">${shortDoi}</a>`;
            }
            return `<a href="${doiUrl}" target="_blank" class="doi-link" title="${shortDoi}">${shortDoi.substring(0, 25)}${shortDoi.length > 25 ? '...' : ''}</a>`;
        }

        function truncateText(text, maxLength = 60) {
            if (!text) return '-';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatAuthors(authorData) {
            if (!authorData) return '-';

            // Try to parse as JSON
            try {
                const authors = JSON.parse(authorData);
                if (Array.isArray(authors)) {
                    // Handle array of author objects or strings
                    const names = authors.map(a => {
                        if (typeof a === 'string') return a;
                        if (a.family && a.given) return `${a.given} ${a.family}`;
                        if (a.name) return a.name;
                        if (a.family) return a.family;
                        return JSON.stringify(a);
                    });
                    return escapeHtml(names.join(', '));
                }
                return escapeHtml(authorData);
            } catch (e) {
                // Not JSON, return as-is
                return escapeHtml(authorData);
            }
        }

        function formatUrlOrDoi(url, doi) {
            if (url) {
                const displayUrl = url.length > 40 ? url.substring(0, 40) + '...' : url;
                return `<a href="${escapeHtml(url)}" target="_blank" class="doi-link">${escapeHtml(displayUrl)}</a>`;
            }
            if (doi) {
                return formatDOI(doi, true);
            }
            return '-';
        }

        function formatUrlOrDoiShort(url, doi) {
            if (url) {
                const displayUrl = url.length > 25 ? url.substring(0, 25) + '...' : url;
                return `<a href="${escapeHtml(url)}" target="_blank" class="doi-link" title="${escapeHtml(url)}">${escapeHtml(displayUrl)}</a>`;
            }
            if (doi) {
                return formatDOI(doi, false);
            }
            return '-';
        }

        function formatDetailRow(rowData) {
            return `
                <div class="detail-row">
                    <div class="detail-grid">
                        <div class="detail-card">
                            <h6>Original Study</h6>
                            <div class="detail-section">
                                <div><span class="detail-label">Title:</span> <span class="detail-value">${escapeHtml(rowData.title_o) || '-'}</span></div>
                                <div><span class="detail-label">Authors:</span> <span class="detail-value">${formatAuthors(rowData.author_o)}</span></div>
                                <div><span class="detail-label">Year:</span> <span class="detail-value">${escapeHtml(rowData.year_o) || '-'}</span></div>
                                <div><span class="detail-label">DOI:</span> <span class="detail-value">${formatDOI(rowData.doi_o, true)}</span></div>
                                ${rowData.journal_o ? `<div><span class="detail-label">Journal:</span> <span class="detail-value">${escapeHtml(rowData.journal_o)}</span></div>` : ''}
                            </div>
                        </div>
                        <div class="detail-card">
                            <h6>Replication Study</h6>
                            <div class="detail-section">
                                <div><span class="detail-label">Title:</span> <span class="detail-value">${escapeHtml(rowData.title_r) || '-'}</span></div>
                                <div><span class="detail-label">Authors:</span> <span class="detail-value">${formatAuthors(rowData.author_r)}</span></div>
                                <div><span class="detail-label">Year:</span> <span class="detail-value">${escapeHtml(rowData.year_r) || '-'}</span></div>
                                <div><span class="detail-label">Report:</span> <span class="detail-value">${formatUrlOrDoi(rowData.url_r, rowData.doi_r)}</span></div>
                                ${rowData.journal_r ? `<div><span class="detail-label">Journal:</span> <span class="detail-value">${escapeHtml(rowData.journal_r)}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="detail-card mt-3">
                        <h6>Replication Details</h6>
                        <div class="detail-section">
                            <div><span class="detail-label">Outcome:</span> <span class="detail-value">${getOutcomeBadge(rowData.outcome)}</span></div>
                            ${rowData.outcome_quote ? `<div><span class="detail-label">Outcome Quote:</span> <span class="detail-value" style="font-style: italic;">"${escapeHtml(rowData.outcome_quote)}"</span></div>` : ''}
                            <div><span class="detail-label">Type:</span> <span class="detail-value">${escapeHtml(rowData.type) || '-'}</span></div>
                            ${rowData.effect_o ? `<div><span class="detail-label">Original Effect:</span> <span class="detail-value">${escapeHtml(rowData.effect_o)}</span></div>` : ''}
                            ${rowData.effect_r ? `<div><span class="detail-label">Replication Effect:</span> <span class="detail-value">${escapeHtml(rowData.effect_r)}</span></div>` : ''}
                            ${rowData.n_o ? `<div><span class="detail-label">Original N:</span> <span class="detail-value">${escapeHtml(rowData.n_o)}</span></div>` : ''}
                            ${rowData.n_r ? `<div><span class="detail-label">Replication N:</span> <span class="detail-value">${escapeHtml(rowData.n_r)}</span></div>` : ''}
                            ${rowData.description ? `<div><span class="detail-label">Description:</span> <span class="detail-value">${escapeHtml(rowData.description)}</span></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStats(data) {
            const total = data.length;
            let successful = 0, failed = 0, mixed = 0;

            data.forEach(row => {
                const outcome = (row.outcome || '').toLowerCase();
                if (outcome.includes('success') || outcome === 'replicated') {
                    successful++;
                } else if (outcome.includes('fail') || outcome === 'not replicated') {
                    failed++;
                } else if (outcome.includes('mixed') || outcome.includes('partial')) {
                    mixed++;
                }
            });

            document.getElementById('total-count').textContent = total;
            document.getElementById('successful-count').textContent = successful;
            document.getElementById('failed-count').textContent = failed;
            document.getElementById('mixed-count').textContent = mixed;
            document.getElementById('stats-row').style.display = 'flex';
        }

        // Create searchable text from all relevant fields
        function createSearchableText(row) {
            const fields = [
                row.title_o, row.author_o, row.journal_o,
                row.title_r, row.author_r, row.journal_r,
                row.doi_o, row.doi_r,
                row.outcome, row.type, row.description
            ];
            return fields.filter(f => f).join(' | ');
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        console.warn('CSV parsing warnings:', results.errors);
                    }

                    const data = results.data;
                    fullRowData = data; // Store for detail view
                    updateStats(data);

                    const tableData = data.map((row, index) => [
                        null, // Details control column
                        {
                            display: truncateText(row.title_o || row.author_o, 50),
                            search: `${row.title_o || ''} ${row.author_o || ''} ${row.journal_o || ''}`
                        },
                        row.year_o || '-',
                        {
                            display: truncateText(row.title_r || row.author_r, 50),
                            search: `${row.title_r || ''} ${row.author_r || ''} ${row.journal_r || ''}`
                        },
                        row.year_r || '-',
                        {
                            display: getOutcomeBadge(row.outcome),
                            search: `${row.outcome || ''} ${row.outcome_quote || ''}`
                        },
                        truncateText(row.type, 15) || '-',
                        {
                            display: formatDOI(row.doi_o),
                            search: row.doi_o || ''
                        },
                        {
                            display: formatUrlOrDoiShort(row.url_r, row.doi_r),
                            search: `${row.url_r || ''} ${row.doi_r || ''}`
                        }
                    ]);

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('flora-table').style.display = 'table';

                    const table = $('#flora-table').DataTable({
                        data: tableData,
                        responsive: false,
                        pageLength: 25,
                        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                        order: [[4, 'desc']], // Sort by replication year descending (now column 4)
                        language: {
                            search: "Search:",
                            searchPlaceholder: "Filter studies (searches full references)..."
                        },
                        columnDefs: [
                            {
                                targets: 0,
                                className: 'details-control',
                                orderable: false,
                                data: null,
                                defaultContent: '',
                                width: '30px'
                            },
                            {
                                targets: [1, 3],
                                width: '20%',
                                render: function(data, type) {
                                    if (type === 'display') {
                                        return typeof data === 'object' ? data.display : data;
                                    }
                                    return typeof data === 'object' ? data.search : data;
                                }
                            },
                            { targets: [2, 4], width: '5%' },
                            {
                                targets: 5,
                                width: '9%',
                                render: function(data, type) {
                                    if (type === 'display') {
                                        return typeof data === 'object' ? data.display : data;
                                    }
                                    return typeof data === 'object' ? data.search : data;
                                }
                            },
                            { targets: 6, width: '6%' }, // Type column - smaller
                            {
                                targets: [7, 8],
                                width: '12%',
                                render: function(data, type) {
                                    if (type === 'display') {
                                        return typeof data === 'object' ? data.display : data;
                                    }
                                    return typeof data === 'object' ? data.search : data;
                                }
                            }
                        ],
                        createdRow: function(row, data, dataIndex) {
                            $(row).attr('data-index', dataIndex);
                        }
                    });

                    // Add event listener for opening and closing details
                    $('#flora-table tbody').on('click', 'td.details-control', function() {
                        const tr = $(this).closest('tr');
                        const row = table.row(tr);
                        const dataIndex = tr.attr('data-index');

                        if (row.child.isShown()) {
                            // Close the row
                            row.child.hide();
                            tr.removeClass('shown');
                        } else {
                            // Open the row
                            row.child(formatDetailRow(fullRowData[dataIndex])).show();
                            tr.addClass('shown');
                        }
                    });
                },
                error: function(error) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message').textContent =
                        'Error loading data: ' + error.message + '. Please try refreshing the page.';
                }
            });
        }

        // Load data when page is ready
        $(document).ready(function() {
            loadData();
        });
    </script>
</body>
</html>
